---
title: "Historical Records for Hummingbirds and Plants"
author: "Ben Weinstein"
date: "Thursday, January 08, 2015"
output:
  html_document:
    theme: spacelab
---


```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(dplyr)
library(reshape2)
library(ggplot2)
library(rgbif)
library(knitr)

opts_chunk$set(message=FALSE,warning=FALSE,fig.width=13,echo=FALSE,cache=TRUE,cache.path = 'gbif_cache/', fig.path='figuregbif/')
```

#Aim



#Approach

#Plant Records

Search for all penstemon records

### Search for occurrence IDs in GBIF
```{r}
out <- name_backbone(name='Penstemon',rank="genus")
head(out)
```

##Get all records with this genus key
```{r,eval=F}
dataout <- occ_search(scientificName = "Penstemon*", coordinatestatus = TRUE, removeZeros = TRUE, limit = 110000,continent="north_america")

#get rid of unknown records
#How many results did we find
print(paste("There were",dataout$meta$count, "records"))

dat<-dataout$data

basisOfRecord=c("FOSSIL_SPECIMEN","HUMAN_OBSERVATION","LITERATURE","LIVING_SPECIMEN","MACHINE_OBSERVATION","OBSERVATION","PRESERVED_SPECIMEN")
                
dat<-dat[dat$basisOfRecord %in% basisOfRecord,]
                
write.csv(dat,"Data/Penstemon.csv")
```

```{r}
#optionally read in data 
dat<-read.csv("Data/Penstemon.csv")

#missing year stamp
missing<-dat[is.na(dat$year),]
```

#Records over time

```{r}
s<-group_by(dat,year) %>% summarize(n=n())
s$Time<-strptime(paste(s$month,1,s$year,sep="/"),format="%m/%d/%Y")

ggplot(data=s,aes(x=year,y=n))  + geom_point() + theme_bw() + ggtitle("GBIF Penstemon Records") + ylim(0,1000) + geom_smooth()
```

##Where do these records come from?

```{r}
datplot<-dat
datplot$name<-"Penstemon"
datplot$species<-"Penstemon"
gbifmap(input=datplot,mapdatabase="usa")
```

#Flowering Duration for each species, across time
Assuming that the vast majority of plants are colleced in flower
```{r,fig.height=30}
#just get the most common species for the moment, atleast 50 records
keep<-names(which(table(dat$species)>100))
dplot<-dat %>% filter(species %in% keep) %>% mutate(minm=mean(month,na.rm=T)) %>% arrange(minm) %>% mutate(Month.abb=factor(month.abb[month],levels=month.abb))

p<-ggplot(dplot,aes(x=species,y=month)) + geom_violin(fill="black") + theme_bw() + coord_flip() + scale_y_discrete(labels=month.abb)
p
```

